오케이—클립이 안 생길 때는 보통 아래 중 하나예요:

녹화(세그먼트) 자체가 안 쌓임 → /var/rec/seg_*.mp4가 없음

ffmpeg 미설치/실패 → make_clip.py가 실패

이벤트 ts와 세그먼트 파일의 타임스탬프가 안 맞음

/var/archive 권한/공간 문제

아래를 위에서부터 순서대로 확인/수정해 보자.

1) 세그먼트가 실제로 쌓이는지 확인
ls -lh /var/rec | tail


기대: seg_169....mp4 같은 파일이 10초마다 새로 생기고 용량이 증가

없다면 → 녹화 서비스 확인:

systemctl status v2x-recorder.service
journalctl -u v2x-recorder.service -f


RTSP_URL_HERE 그대로면 ffmpeg가 입력을 못 잡습니다. 두 가지 중 하나로 바꿔 실행:

(A) RTSP 카메라일 때

/etc/systemd/system/v2x-recorder.service 안의 ExecStart=에서
"RTSP_URL_HERE" → 실제 RTSP URL로 교체

(B) 웹캠/더미 입력으로 테스트할 때

유닛 파일에서 RTSP 줄을 주석 처리하고, 아래 줄로 교체:

ExecStart=/usr/bin/ffmpeg -nostdin -y -f lavfi -i testsrc=size=640x360:rate=30 \
  -f segment -segment_time 10 -strftime 1 -reset_timestamps 1 /var/rec/seg_%s.mp4


적용:

sudo systemctl daemon-reload
sudo systemctl restart v2x-recorder.service


→ 다시 /var/rec에 파일이 생기는지 확인.

2) ffmpeg 설치/경로 확인
which ffmpeg
ffmpeg -version | head -n1


없으면 설치(Ubuntu 예):

sudo apt-get update && sudo apt-get install -y ffmpeg

3) 수동으로 클립 생성이 되는지 먼저 테스트

녹화가 돌고 있고 /var/rec/seg_*.mp4가 생긴다는 전제에서:

python3 /opt/v2x/make_clip.py $(date +%s)
ls -lh /var/archive | tail


성공 메시지 예: saved: /var/archive/accident_169...mp4

에러 메시지가 뜬다면 그 문구를 알려줘. (원인 바로 잡아줄게)

참고: make_clip.py는 현재 시각 기준 전후 5분 세그먼트가 있어야 합니다. 녹화를 막 켠 지 1분도 안 됐다면 파일이 부족해서 실패할 수 있어요. 5~6분 정도 녹화가 돌게 둔 뒤 다시 시도해 봐.

4) 이벤트 ts와 세그먼트 시간대가 맞는지

emit_event.py는 실행 시각을 ts로 쓰므로 보통 맞습니다.
다만, 워처를 오래 끈 뒤 과거 파일로 재실행 같은 경우 ts가 과거가 될 수 있음 → 그 시각대의 세그먼트가 없어서 실패.

확인:

jq . /opt/v2x/events/*.json 2>/dev/null | grep '"ts"' | tail
date -d @<그_ts값>


→ 너무 과거면 새 이벤트를 다시 쏘세요:

python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint

5) /var/archive 권한/공간
df -h /
ls -ld /var/archive
sudo mkdir -p /var/archive
sudo chown $USER:$USER /var/archive
sudo chmod 755 /var/archive

6) 워처가 클립을 제대로 호출하는지 로그 확인
journalctl -u v2x-watcher.service -f


이벤트 감지 시 에러 없이 돌아가는지 확인

필요하면 make_clip.py를 단발로만 먼저 확인(위 3번)

한 번에 되는 “더미 전체 테스트”

녹화: testsrc로 계속 세그먼트 생성(10초 간격)

새 이벤트 쏘기 → 워처가 방송 + 클립 생성

# 1) 더미 녹화가 도는지 확인
systemctl restart v2x-recorder.service
sleep 20
ls -lh /var/rec | tail

# 2) 이벤트 발사
python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint

# 3) 아카이브 확인
sleep 5
ls -lh /var/archive | tail


이렇게 점검해도 /var/archive/accident_<ts>.mp4 가 안 생기면,

journalctl -u v2x-recorder.service -b --no-pager | tail -n 50

python3 /opt/v2x/make_clip.py $(date +%s) 실행 결과(성공/실패 메시지)
두 개의 출력만 텍스트로 보내줘. 바로 원인 특정해서 수정해줄게.
