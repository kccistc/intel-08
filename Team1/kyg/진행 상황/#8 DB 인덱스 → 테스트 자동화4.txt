좋은 에러 사례예요. 메시지를 해석하면:

Could not write header (incorrect codec parameters ?): No such file or directory

Nothing was written into output file, because at least one of its streams received no packets.

→ 출력 디렉터리 문제이거나(경로/권한) 입력(웹캠)에서 프레임이 전혀 안 들어오는 상황일 때 나옵니다. 시스템드 유닛 문법 자체(v2x-recorder.service)보단 ffmpeg 입력/출력 조건이 문제일 확률이 큽니다.

아래 순서대로 점검/해결하면 바로 됩니다.

0) 출력 경로/권한 확인
sudo mkdir -p /var/rec
sudo chmod 777 /var/rec     # 테스트 용(운영 시 755/소유권 조정)


/var/rec 가 없으면 위 에러가 바로 납니다.

1) 웹캠 장치/포맷 확인
ls -l /dev/video*
# 없다면 연결/드라이버 문제

# v4l2-utils가 없다면 설치
sudo apt-get update && sudo apt-get install -y v4l-utils

# 장치와 포맷 확인
v4l2-ctl --list-devices
v4l2-ctl -d /dev/video0 --list-formats-ext


출력에 MJPG(MJPEG) 또는 YUYV 같은 포맷이 보일 거예요.

2) systemd 끄고, 수동 ffmpeg로 먼저 테스트
(A) MJPEG 카메라일 때(가장 흔함, CPU부담↓)
# 3초짜리 샘플 캡처(무인코딩, MKV 컨테이너)
ffmpeg -f v4l2 -input_format mjpeg -framerate 30 -video_size 1280x720 \
  -i /dev/video0 -t 3 -c copy test.mkv


test.mkv가 정상 재생되면 OK.

mp4 컨테이너에 MJPEG을 그대로 담아도 되지만 호환성 때문에 mkv가 안전합니다.

(B) YUYV 카메라일 때(인코딩 필요, CPU부담↑)
ffmpeg -f v4l2 -input_format yuyv422 -framerate 30 -video_size 640x480 \
  -i /dev/video0 -t 3 -c:v libx264 -preset veryfast -crf 23 test.mp4


파일이 잘 나오면 OK.

여기서 테스트가 실패하면 유닛이든 뭐든 다 실패합니다. 우선 이 수동 캡처가 성공해야 해요. 실패 시 에러 문구를 알려주면 거기서 바로 잡아줄게요.

3) 유닛 ExecStart를 성공한 케이스로 교체
✅ MJPEG(권장: 무인코딩 세그먼트, CPU↓)
sudo tee /etc/systemd/system/v2x-recorder.service >/dev/null <<'EOF'
[Unit]
Description=V2X Circular Recorder (FFmpeg 10s segments)
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/ffmpeg -nostdin -y \
  -f v4l2 -input_format mjpeg -framerate 30 -video_size 1280x720 \
  -i /dev/video0 \
  -c copy -f segment -segment_time 10 -reset_timestamps 1 -strftime 1 \
  /var/rec/seg_%s.mkv
Restart=always
RestartSec=2
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

✅ YUYV(인코딩 필요, CPU↑)
sudo tee /etc/systemd/system/v2x-recorder.service >/dev/null <<'EOF'
[Unit]
Description=V2X Circular Recorder (FFmpeg 10s segments)
After=network-online.target

[Service]
Type=simple
ExecStart=/usr/bin/ffmpeg -nostdin -y \
  -f v4l2 -input_format yuyv422 -framerate 30 -video_size 640x480 \
  -i /dev/video0 \
  -c:v libx264 -preset veryfast -crf 23 \
  -f segment -segment_time 10 -reset_timestamps 1 -strftime 1 \
  /var/rec/seg_%s.mp4
Restart=always
RestartSec=2
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF


적용/시작:

sudo systemctl daemon-reload
sudo systemctl restart v2x-recorder.service
journalctl -u v2x-recorder.service -f
# 20~30초 후
ls -lh /var/rec | tail   # seg_*.mkv(or .mp4)가 10초마다 생겨야 정상

4) 클립 생성 다시 확인

녹화 파일이 쌓이기 시작하면, 이벤트를 쏴서 클립 생성 확인:

python3 /opt/v2x/emit_event.py --type collision --severity high --clip-hint
# 또는 수동:
python3 /opt/v2x/make_clip.py $(date +%s)
ls -lh /var/archive | tail

아직 실패한다면

수동 ffmpeg 테스트의 에러 메시지를 보내줘요. (가장 결정적)

v2x-recorder.service 전체 내용(systemctl cat v2x-recorder.service)과
v4l2-ctl -d /dev/video0 --list-formats-ext 결과를 보내주면,
거기에 딱 맞는 ExecStart 한 줄로 바로 만들어줄게.
