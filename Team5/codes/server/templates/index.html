<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•´ì–‘ ì‹œìŠ¤í…œ í†µí•© ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .data-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
        }
        .data-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">âš“ í•´ì–‘ ì‹œìŠ¤í…œ í†µí•© ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-gray-500 mt-1">MQTT & SocketIO ì‹¤ì‹œê°„ ë°ì´í„° ëª¨ë‹ˆí„°ë§ ë° LLM ë³´ê³ ì„œ</p>
        </header>

        <!-- ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ë°ìŠ¤í¬í†± 2ì—´, ëª¨ë°”ì¼ 1ì—´) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- ì¢Œì¸¡: ì‹¤ì‹œê°„ ìƒíƒœ ë° LLM -->
            <div class="lg:col-span-2 space-y-6">

                <!-- ì„¹ì…˜ 1: IMU & Vision ì‹¤ì‹œê°„ ìƒíƒœ -->
                <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- IMU Roll -->
                    <div id="imu-roll-card" class="data-card bg-white p-6 rounded-xl border border-gray-200">
                        <div class="text-sm font-semibold text-gray-500">ì„ ì²´ ê¸°ìš¸ê¸° (Roll)</div>
                        <div class="text-4xl font-bold mt-2 text-blue-700 flex items-baseline">
                            <span id="imu-roll">0.00</span>
                            <span class="text-xl ml-1">Â°</span>
                        </div>
                        <p id="roll-status" class="text-xs mt-1 text-green-500 font-medium">ì•ˆì •ì </p>
                    </div>
                    <!-- IMU Pitch -->
                    <div id="imu-pitch-card" class="data-card bg-white p-6 rounded-xl border border-gray-200">
                        <div class="text-sm font-semibold text-gray-500">ì„ ì²´ ìƒí•˜ ë™ìš” (Pitch)</div>
                        <div class="text-4xl font-bold mt-2 text-gray-800 flex items-baseline">
                            <span id="imu-pitch">0.00</span>
                            <span class="text-xl ml-1">Â°</span>
                        </div>
                        <p class="text-xs mt-1 text-gray-400 font-medium">ì‹¤ì‹œê°„ ë°ì´í„°</p>
                    </div>
                    <!-- IMU Yaw -->
                    <div id="imu-yaw-card" class="data-card bg-white p-6 rounded-xl border border-gray-200">
                        <div class="text-sm font-semibold text-gray-500">ì„ ìˆ˜ ë°©í–¥ (Yaw)</div>
                        <div class="text-4xl font-bold mt-2 text-gray-800 flex items-baseline">
                            <span id="imu-yaw">0.00</span>
                            <span class="text-xl ml-1">Â°</span>
                        </div>
                        <p class="text-xs mt-1 text-gray-400 font-medium">ìµœì¢… ì—…ë°ì´íŠ¸:</p>
                        <span id="imu-ts" class="text-xs text-gray-400"></span>
                    </div>
                </section>

                <!-- ì„¹ì…˜ 2: LLM í•­í•´ ë³´ê³ ì„œ -->
                <section class="data-card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                        <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-1.385l3.5-3.5L16.385 10 20 6.385V5.5a1.5 1.5 0 00-1.5-1.5h-11a1.5 1.5 0 00-1.5 1.5v13a1.5 1.5 0 001.5 1.5H8.5V17zM18.5 10l-3.5 3.5m0 0l-3.5 3.5m3.5-3.5V17"></path></svg>
                        LLM í•­í•´ ë³´ê³ ì„œ & ì‘ë‹µ
                    </h2>
                    <div id="llm-output-area" class="border border-gray-300 bg-gray-50 p-4 rounded-lg min-h-[150px] relative">
                        <p id="llm-message" class="text-gray-700 leading-relaxed italic">
                            ìŒì„± ëª…ë ¹ (ì˜ˆ: "ìµœê·¼ 30ë¶„ ìš”ì•½í•´ì¤˜")ì´ ìˆ˜ì‹ ë˜ë©´ ì—¬ê¸°ì— LLMì˜ ë³´ê³ ì„œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                        </p>
                        <p id="llm-context" class="text-xs text-gray-400 mt-2 text-right"></p>
                    </div>
                </section>

                <!-- ì„¹ì…˜ 3: Vision/AD/PE ì‹¤ì‹œê°„ ê°ì§€ í˜„í™© -->
                <section class="data-card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                        <svg class="w-6 h-6 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.552-4.552a1.5 1.5 0 012.112 2.112L17.112 12m-2.112-2.112V6a1.5 1.5 0 00-1.5-1.5h-6A1.5 1.5 0 005.5 6v10.5a1.5 1.5 0 001.5 1.5h3.5"></path></svg>
                        Vision ëª¨ë“ˆ ì‹¤ì‹œê°„ ê°ì§€ (AD/PE)
                    </h2>
                    <div id="vision-raw-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                        <p class="text-sm text-gray-400">Vision/AD/PE ëª¨ë“ˆì—ì„œ ì „ì†¡ëœ RAW ê°ì§€ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                    </div>
                </section>
                
            </div>

            <!-- ìš°ì¸¡: ì´ë²¤íŠ¸ ë¡œê·¸ ë° ì•Œë¦¼ ê¸°ë¡ -->
            <div class="lg:col-span-1 space-y-6">

                <!-- ì„¹ì…˜ 4: ì‹¤ì‹œê°„ ì•Œë¦¼ ê¸°ë¡ (ALERT/CRITICAL) -->
                <section class="data-card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-red-600 flex items-center mb-4">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.332 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        ì‹¤ì‹œê°„ ì•Œë¦¼ (ALERT / CRITICAL)
                    </h2>
                    <div id="alert-history" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                        <div class="bg-blue-100 text-blue-800 p-3 rounded-md text-sm">ì‹œìŠ¤í…œ ì‹œì‘ë¨. ì•Œë¦¼ ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </section>

                <!-- ì„¹ì…˜ 5: ì „ì²´ ì´ë²¤íŠ¸ ë¡œê·¸ -->
                <section class="data-card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                        <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        ì „ì²´ ì‹œìŠ¤í…œ ì´ë²¤íŠ¸ ë¡œê·¸ (DB ì €ì¥ ì™„ë£Œ)
                    </h2>
                    <div id="event-log" class="text-xs space-y-1 max-h-96 overflow-y-auto custom-scrollbar bg-gray-800 text-gray-200 p-3 rounded-md">
                        <div class="text-gray-400">ì„œë²„ ì—°ê²° ì¤‘...</div>
                    </div>
                </section>

            </div>
        </div>
    </div>

    <!-- Socket.IO í´ë¼ì´ì–¸íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js"></script>
    <script>
        // Flask-SocketIOëŠ” í˜„ì¬ í˜¸ìŠ¤íŠ¸ì— ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
        const socket = io();

        const imuRoll = document.getElementById('imu-roll');
        const imuPitch = document.getElementById('imu-pitch');
        const imuYaw = document.getElementById('imu-yaw');
        const imuTs = document.getElementById('imu-ts');
        const rollStatus = document.getElementById('roll-status');
        const imuRollCard = document.getElementById('imu-roll-card');
        
        const eventLog = document.getElementById('event-log');
        const alertHistory = document.getElementById('alert-history');
        const llmMessage = document.getElementById('llm-message');
        const llmContext = document.getElementById('llm-context');
        const visionRawList = document.getElementById('vision-raw-list');

        let isInitialLog = true;
        
        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function formatTime(ts) {
            // ts: "YYYY-MM-DD HH:MM:SS.ffffff" ë˜ëŠ” ISO 8601 í˜•ì‹ ì²˜ë¦¬
            try {
                const parts = ts.split(' ');
                if (parts.length > 1) {
                    return parts[1].split('.')[0]; // HH:MM:SS
                }
                const isoTimeMatch = ts.match(/T(\d{2}:\d{2}:\d{2})/);
                if (isoTimeMatch) {
                    return isoTimeMatch[1];
                }
                return ts; // Fallback
            } catch (e) {
                return ts;
            }
        }

        // --- SocketIO ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        socket.on('connect', function() {
            console.log('SocketIO ì—°ê²° ì„±ê³µ!');
            // ì—°ê²° ì‹œ ì´ˆê¸° ë¡œê·¸ ë©”ì‹œì§€ ì¶”ê°€
            eventLog.innerHTML = `<div class="text-green-400">âœ… [${formatTime(new Date().toISOString())}] ì„œë²„ ì—°ê²° ì„±ê³µ! ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ì‹œì‘.</div>`;
            isInitialLog = false; // ì´ˆê¸° ë©”ì‹œì§€ ì œê±° ë¡œì§ì„ ìœ„í•œ í”Œë˜ê·¸ ì—…ë°ì´íŠ¸
        });
        
        // 1. LLM ìš”ì•½ ë³´ê³ ì„œ ìˆ˜ì‹ 
        socket.on('llm_summary', function(data) {
            llmMessage.innerHTML = data.text;
            llmContext.textContent = `[ë³´ê³  ì‹œê°„: ${formatTime(data.time)}] ìµœê·¼ ${data.minutes}ë¶„ ê°„ì˜ í•­í•´ì¼ì§€ ìš”ì•½.`;
            llmMessage.className = 'text-gray-700 leading-relaxed font-medium';
        });

        // 2. LLM ì§ˆì˜ì‘ë‹µ ìˆ˜ì‹ 
        socket.on('llm_response', function(data) {
            llmMessage.innerHTML = `**Q:** ${data.query}<br>**A:** ${data.response}`;
            llmContext.textContent = `[ì‘ë‹µ ì‹œê°„: ${formatTime(data.time)}] ìŒì„± ì§ˆì˜ ì‘ë‹µ ê²°ê³¼.`;
            // ì‘ë‹µ êµ¬ë¶„ì„ ìœ„í•´ í‘¸ë¥¸ìƒ‰ ë°°ê²½ ì¶”ê°€
            llmMessage.className = 'text-gray-700 leading-relaxed font-medium bg-blue-50 p-2 rounded'; 
        });

        // 3. IMU RAW ë°ì´í„° ì—…ë°ì´íŠ¸
        socket.on('imu_update', function(data) {
            const roll = parseFloat(data.data.roll || data.data.roll_angle).toFixed(2);
            const pitch = parseFloat(data.data.pitch).toFixed(2);
            const yaw = parseFloat(data.data.yaw).toFixed(2);
            
            imuRoll.textContent = roll;
            imuPitch.textContent = pitch;
            imuYaw.textContent = yaw;
            imuTs.textContent = formatTime(data.ts);

            // Roll ìœ„í—˜ ìƒíƒœ í‘œì‹œ ë¡œì§ (í•µì‹¬ ì¶”ê°€/ë³€ê²½ ì‚¬í•­)
            const absRoll = Math.abs(roll);
            // ê¸°ì¡´ ë°°ê²½ í´ë˜ìŠ¤ ì´ˆê¸°í™”
            imuRollCard.classList.remove('bg-red-100', 'bg-orange-100');
            imuRollCard.classList.add('bg-white');
            rollStatus.classList.remove('text-green-500', 'text-orange-600', 'text-red-600');
            
            if (absRoll > 30) {
                rollStatus.textContent = 'CRITICAL: ì „ë³µ ìœ„í—˜';
                rollStatus.classList.add('text-red-600');
                imuRollCard.classList.add('bg-red-100'); // ìœ„í—˜ ê²½ê³  ìƒ‰ìƒ
            } else if (absRoll > 15) {
                rollStatus.textContent = 'WARNING: ê³¼ë„í•œ ë¡¤ë§';
                rollStatus.classList.add('text-orange-600');
                imuRollCard.classList.add('bg-orange-100'); // ê²½ê³  ìƒ‰ìƒ
            } else {
                rollStatus.textContent = 'ì•ˆì •ì ';
                rollStatus.classList.add('text-green-500');
            }
        });

        // 4. VISION/AD/PE RAW ë°ì´í„° ì—…ë°ì´íŠ¸
        socket.on('vision_raw_update', function(data) {
            const moduleName = data.module;
            const ts = formatTime(data.ts);
            const detections = data.data.detections || data.data.details || [];
            
            // Vision Raw ë¦¬ìŠ¤íŠ¸ë¥¼ ìµœì‹  5ê°œë¡œ ìœ ì§€ (ì„±ëŠ¥ ê´€ë¦¬)
            let newContent = detections.map(d => {
                const object = d.object_type || d.object || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const score = (d.confidence || d.score || 0) * 100;
                return `<div class="text-xs p-2 bg-gray-100 rounded-lg">
                            <span class="font-bold text-gray-700">(${ts}) ${moduleName}:</span> 
                            ${object} (${score.toFixed(1)}%) - ${d.description || 'ê°ì§€ë¨'}
                        </div>`;
            }).join('');

            // ìƒˆ ë‚´ìš© ì¶”ê°€ ë° ìµœëŒ€ í•­ëª© ìœ ì§€
            const maxItems = 5;
            visionRawList.innerHTML = newContent + visionRawList.innerHTML;
            
            // ì´ˆê¸° ë©”ì‹œì§€ ì‚­ì œ ë° í•­ëª© ìˆ˜ ì œí•œ
            while (visionRawList.children.length > maxItems || (visionRawList.lastChild && visionRawList.lastChild.textContent.includes('RAW ê°ì§€ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œ'))) {
                 visionRawList.removeChild(visionRawList.lastChild);
            }
        });

        // 5. ì „ì²´ ì´ë²¤íŠ¸ ë¡œê·¸ ìˆ˜ì‹  (DB ì €ì¥ í›„ í˜¸ì¶œë¨)
        socket.on('event_log', function(data) {
            const logElement = document.createElement('div');
            const ts = formatTime(data.ts);
            
            let colorClass = 'text-gray-300'; // ê¸°ë³¸ INFO
            // ì¤‘ìš”ë„ì— ë”°ë¥¸ ìƒ‰ìƒ êµ¬ë¶„
            if (data.action === 'ALERT' || data.action === 'CRITICAL') {
                colorClass = 'text-red-400 font-bold';
            } else if (data.module === 'LLM' || data.module === 'USER_STT') {
                colorClass = 'text-blue-400';
            } else if (data.action === 'RAW') {
                colorClass = 'text-green-400';
            }

            logElement.className = `whitespace-nowrap overflow-hidden overflow-ellipsis ${colorClass}`;
            logElement.textContent = `[${ts}] [${data.module}/${data.action}] ${data.payload}`;

            // ìƒˆë¡œìš´ ë¡œê·¸ë¥¼ ë§¨ ìœ„ì— ì¶”ê°€ (ê°€ì¥ ìµœê·¼ ë¡œê·¸ê°€ ìœ„ë¡œ)
            eventLog.prepend(logElement);

            // ì´ˆê¸° "ì„œë²„ ì—°ê²° ì¤‘" ë©”ì‹œì§€ ì œê±° (ìµœì´ˆ 1íšŒë§Œ)
            if (isInitialLog && eventLog.children.length > 1) {
                eventLog.removeChild(eventLog.children[1]);
                isInitialLog = false;
            }
        });

        // 6. ALERT/CRITICAL ê²½ê³  ìˆ˜ì‹ 
        socket.on('alert_event', function(data) {
            const alertElement = document.createElement('div');
            const ts = formatTime(data.ts);
            // í† í”½ íŒŒì‹±ì„ í†µí•´ ëª¨ë“ˆê³¼ ì•¡ì…˜ ì¶”ì¶œ
            const topicParts = data.topic.split('/');
            const module = topicParts.length > 2 ? topicParts[2].toUpperCase() : 'UNKNOWN';
            const action = topicParts.length > 3 ? topicParts[3].toUpperCase() : 'ALERT';

            // ì• ë‹ˆë©”ì´ì…˜ ë° ë¹¨ê°„ìƒ‰ ë°°ê²½ ì ìš© (ì‹œê°ì  ê²½ê³  ê·¹ëŒ€í™”)
            alertElement.className = 'bg-red-600 text-white p-3 rounded-md text-sm animate-pulse data-card';
            alertElement.innerHTML = `
                <span class="font-bold mr-2">ğŸš¨ ${action} ì•Œë¦¼!</span> 
                (${ts}) ${module}: ${data.payload.message || JSON.stringify(data.payload)}
            `;
            
            // ìƒˆë¡œìš´ ì•Œë¦¼ì„ ë§¨ ìœ„ì— ì¶”ê°€
            alertHistory.prepend(alertElement);

            // ì´ˆê¸° ë©”ì‹œì§€ ì œê±°
            const initialMessage = alertHistory.querySelector('.bg-blue-100');
            if (initialMessage) {
                alertHistory.removeChild(initialMessage);
            }
        });
        
    </script>
</body>
</html>
